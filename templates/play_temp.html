<!doctype html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>נחש ה-11 הפותחים - רשימה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f0f4f8;
        }
        .feedback-box {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            border-radius: 4px;
            margin: 1px;
        }
        .feedback-gray { background-color: #6C757D; }
        .feedback-yellow { background-color: #FFC107; }
        .feedback-green { background-color: #4CAF50; }
        /* Ensuring RTL for elements like names and boxes */
        .guess-row { direction: rtl; } 
        .player-info { width: 30%; }
        .guess-area { width: 70%; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-xl mx-auto" dir="rtl">
        
        <!-- Game Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800" id="game-title">נחש את ה-11 הפותחים</h1>
            <p id="game-message" class="text-lg text-red-600 font-semibold mt-2">התחל משחק!</p>
            <div id="game-info" class="mt-4 text-gray-600">
                <p>משחק: <span id="competition" class="font-medium">N/A</span> (<span id="match-date">N/A</span>)</p>
                <button onclick="startGame()" class="mt-3 px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150">התחל משחק חדש</button>
            </div>
        </header>

        <!-- Player List -->
        <div id="player-list" class="mt-8 space-y-4">
            <!-- Player guess cards will be injected here -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- CRITICAL FIX: Set base URL for API calls ---
        const API_BASE_URL = 'http://127.0.0.1:5000'; // Flask server location

        const GAME_URL = '/state';
        const START_URL = '/start_game';
        const GUESS_URL = '/guess';

        let gameState = null;

        // --- API Helpers ---

        async function apiFetch(url, method = 'GET', data = null) {
            const fullUrl = API_BASE_URL + url; 
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (data) { options.body = JSON.stringify(data); }

            const response = await fetch(fullUrl, options);
            const result = await response.json();
            
            if (!response.ok) {
                console.error("API Error:", result.error);
                document.getElementById('game-message').textContent = `שגיאה: ${result.error || 'הבקשה נכשלה.'}`;
                return null;
            }
            return result;
        }

        // --- Feedback Renderer (RTL Wordle Logic) ---

        function renderFeedback(guess, feedback, targetLength) {
            const displayDiv = document.createElement('div');
            // CRITICAL RTL: Use flex-row-reverse for boxes, and justify-end for alignment
            displayDiv.className = 'flex flex-row-reverse space-x-1 space-x-reverse justify-end'; 

            const actualName = " ".repeat(targetLength); // Used for calculating skeleton shape
            let charIndex = 0;
            
            // Split the skeleton by spaces (assuming one space for separation)
            // Note: This relies on player.name_length being accurate, including space count
            const nameParts = actualName.split(' ');

            nameParts.forEach((part, partIndex) => {
                if (partIndex > 0) {
                    // Add a small space element between first and last name blocks
                    const space = document.createElement('div');
                    space.className = 'w-2 h-2';
                    displayDiv.appendChild(space);
                }
                
                for (let i = 0; i < part.length; i++) {
                    const box = document.createElement('div');
                    let className = 'feedback-box ';
                    const char = (guess[charIndex] || '').toUpperCase();
                    
                    const fb = feedback[charIndex];
                    
                    if (charIndex < guess.length) {
                        // If a letter was guessed, use the feedback color
                        if (fb === 2) {
                            className += 'feedback-green';
                        } else if (fb === 1) {
                            className += 'feedback-yellow';
                        } else {
                            className += 'feedback-gray';
                        }
                        box.textContent = char;
                    } else {
                        // Skeleton box (Empty gray box)
                        className += 'feedback-gray';
                        box.textContent = '';
                    }
                    
                    box.className = className;
                    displayDiv.appendChild(box);
                    charIndex++;
                }
            });
            return displayDiv;
        }

        // --- Game Flow Functions ---

        async function startGame() {
            document.getElementById('game-message').textContent = "מפעיל משחק חדש...";
            const newState = await apiFetch(START_URL);
            if (newState) {
                gameState = newState;
                updateGameUI(newState);
            }
        }

        async function loadGameState() {
            const newState = await apiFetch(GAME_URL);
            if (newState && !newState.error) {
                gameState = newState;
                updateGameUI(newState);
            } else if (newState && newState.error && newState.error.includes("No active game")) {
                document.getElementById('game-message').textContent = "ברוך הבא! לחץ התחל משחק חדש.";
            }
        }

        function updateGameUI(state) {
            gameState = state;
            
            document.getElementById('game-message').textContent = state.message;
            
            // 1. Update Title and Match Info (Using team name from state)
            document.getElementById('game-title').textContent = `נחש את ה-11 הפותחים | ${state.target_team_name}`;
            document.getElementById('competition').textContent = state.competition;
            document.getElementById('match-date').textContent = new Date(state.match_date).toLocaleDateString('he-IL'); // Hebrew date format
            
            const listContainer = document.getElementById('player-list');
            listContainer.innerHTML = ''; // Clear existing list

            const activeFeedback = state.feedback || {};

            state.lineup.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'flex items-center p-4 bg-white rounded-lg shadow-md guess-row';
                
                // --- Player Info (Number and Position) ---
                const infoDiv = document.createElement('div');
                infoDiv.className = 'player-info flex items-center space-x-4 space-x-reverse text-gray-700';
                
                // Check if player is revealed to show image instead of number
                const playerDisplay = player.is_revealed 
                    ? `<img src="${player.player_img_url}" alt="${player.revealed_name}" class="w-10 h-10 rounded-full border-2 border-green-500">`
                    : `<div class="text-xl font-bold w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-800">${player.index}</div>`;

                infoDiv.innerHTML = `
                    ${playerDisplay}
                    <div class="font-semibold">${player.position}</div>
                `;
                playerCard.appendChild(infoDiv);

                // --- Guess Area (Input and Feedback) ---
                const guessDiv = document.createElement('div');
                guessDiv.className = 'guess-area flex flex-col items-end space-y-2';
                
                if (player.is_revealed) {
                    // --- Revealed Player Name ---
                    guessDiv.innerHTML = `<span class="text-xl font-bold text-gray-900">${player.revealed_name}</span>`;
                } else {
                    // --- Guess Input and Feedback ---
                    
                    const isTargetSlot = (activeFeedback.slot_index === player.index);
                    const currentGuess = isTargetSlot ? activeFeedback.guess : '';
                    const currentFeedback = isTargetSlot ? activeFeedback.feedback : [];

                    // 1. Feedback/Skeleton Row (Always draw skeleton)
                    const feedbackElement = renderFeedback(currentGuess, currentFeedback, player.name_length);
                    guessDiv.appendChild(feedbackElement);

                    // 2. Input Box and Button
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'flex w-full space-x-2 space-x-reverse';
                    
                    const inputField = document.createElement('input');
                    inputField.type = 'text';
                    inputField.id = `input-${player.index}`;
                    inputField.placeholder = "נחש את השם";
                    inputField.className = 'flex-1 p-2 border border-gray-300 rounded-lg text-right';
                    
                    const submitButton = document.createElement('button');
                    submitButton.textContent = 'שלח';
                    submitButton.className = 'px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600';
                    submitButton.onclick = () => submitGuess(player.index);
                    
                    // Event listener for Enter key
                    inputField.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            submitGuess(player.index);
                        }
                    });

                    inputContainer.appendChild(submitButton);
                    inputContainer.appendChild(inputField); 
                    
                    guessDiv.appendChild(inputContainer);
                }

                playerCard.appendChild(guessDiv);
                listContainer.appendChild(playerCard);
                
                // If revealed, and we have an image, update the info box to show the image
                if (player.is_revealed) {
                    infoDiv.innerHTML = `
                        ${playerDisplay}
                        <div class="font-semibold">${player.position}</div>
                    `;
                }
            });
            
            // Focus on the first open input field after updating the UI
            const firstInput = document.querySelector('#player-list input[type="text"]');
            if(firstInput) firstInput.focus();
        }

        // --- Submit Guess Logic (Modified to accept index) ---

        async function submitGuess(index) {
            const guessInput = document.getElementById(`input-${index}`);
            const playerGuess = guessInput.value.trim();

            if (!playerGuess) {
                document.getElementById('game-message').textContent = "נא להכניס שם.";
                return;
            }

            const data = {
                player: playerGuess,
                slot_index: index 
            };

            const newState = await apiFetch(GUESS_URL, 'POST', data);
            if (newState) {
                updateGameUI(newState);
                
                // If incorrect, set the input value again for easy correction
                if (newState.feedback && newState.feedback.slot_index === index) {
                     document.getElementById(`input-${index}`).value = newState.feedback.guess;
                }
            }
        }

        // Initialize game state on load
        window.onload = loadGameState;
    </script>
</body>
</html>
